name: CD - Deploy to GitHub Pages

# Trigger solo su push al branch main
on:
  push:
    branches: [main]

# Permessi necessari per push e deploy
permissions:
  contents: write
  pages: write
  id-token: write

# Previene deploy concorrenti
concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  # Job di deploy
  deploy:
    name: Build and Deploy to GitHub Pages
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout del codice
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Necessario per commit e push
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Setup Node.js with pnpm
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      # 3. Installazione dipendenze
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 4. Cache Playwright browsers (per i test)
      - name: Get Playwright version
        id: playwright-version
        run: echo "version=$(node -p "require('./package.json').devDependencies['@playwright/test']")" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: pnpm exec playwright install --with-deps

      - name: Install Playwright system dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: pnpm exec playwright install-deps

      # 5. ESLint - Quality Gate
      - name: Run ESLint
        run: pnpm run lint
        continue-on-error: true  # Temporarily allow failures (ESLint 8.x + AJV issue)

      # 6. Build packages (required before tests)
      - name: Build packages
        run: pnpm run build

      # 7. Run Tests - Quality Gate
      - name: Run tests
        run: pnpm test
        env:
          CI: true

      # 8. Build root-level demo for GitHub Pages
      - name: Build demo site
        run: pnpm exec vite build
        env:
          NODE_ENV: production

      # 8. Prepare docs/ directory
      - name: Prepare docs directory for deployment
        run: |
          echo "ðŸ“¦ Preparing deployment..."

          # Backup della directory docs/docs (documentazione)
          if [ -d "docs/docs" ]; then
            echo "Backing up documentation..."
            mv docs/docs /tmp/docs-backup
          fi

          # Rimuovi tutto da docs/ eccetto .git (se presente)
          rm -rf docs/*

          # Copia il build da dist/ a docs/
          echo "Copying build files to docs/..."
          cp -r dist/* docs/

          # Ripristina la documentazione
          if [ -d "/tmp/docs-backup" ]; then
            echo "Restoring documentation..."
            mkdir -p docs/docs
            cp -r /tmp/docs-backup/* docs/docs/
            rm -rf /tmp/docs-backup
          fi

          # Crea .nojekyll per evitare che GitHub Pages usi Jekyll
          touch docs/.nojekyll

          echo "âœ… Deployment preparation complete"

      # 9. Verifica contenuto docs/
      - name: Verify docs directory
        run: |
          echo "### Deployment Files ðŸ“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Contents of docs/ directory:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lah docs/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Verifica che index.html esista
          if [ ! -f "docs/index.html" ]; then
            echo "âŒ ERROR: index.html not found in docs/" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      # 10. Commit e Push delle modifiche
      - name: Commit and push to docs/
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Aggiungi tutti i file in docs/
          git add docs/

          # Verifica se ci sono modifiche
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "â„¹ï¸ No changes detected in build output" >> $GITHUB_STEP_SUMMARY
          else
            # Commit con messaggio descrittivo
            git commit -m "ðŸš€ Deploy: Update GitHub Pages

            - Build from commit: ${{ github.sha }}
            - Triggered by: ${{ github.actor }}
            - Branch: ${{ github.ref_name }}

            Generated by GitHub Actions CD pipeline"

            # Push al repository
            git push

            echo "### ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- âœ“ Build successful" >> $GITHUB_STEP_SUMMARY
            echo "- âœ“ Files copied to docs/" >> $GITHUB_STEP_SUMMARY
            echo "- âœ“ Changes committed and pushed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ Site will be available at GitHub Pages in ~1-2 minutes" >> $GITHUB_STEP_SUMMARY
          fi

      # 11. Report finale
      - name: Deployment summary
        if: success()
        run: |
          echo "### âœ… CD Pipeline Completed Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your site is being deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Ensure GitHub Pages is enabled in repository settings" >> $GITHUB_STEP_SUMMARY
          echo "2. Configure source to deploy from /docs folder on main branch" >> $GITHUB_STEP_SUMMARY
          echo "3. Wait 1-2 minutes for deployment to complete" >> $GITHUB_STEP_SUMMARY
