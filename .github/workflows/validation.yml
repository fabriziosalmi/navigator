name: Ecosystem Validation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

# ==========================================
# PERMISSIONS: Explicit GitHub Token Permissions
# ==========================================
# Modern security practice: explicitly declare required permissions
# instead of relying on default permissions
permissions:
  contents: read        # Read repository contents
  pull-requests: write  # Write comments on PRs
  issues: write         # Write comments on issues

# ==========================================
# SMART CI: Parallel Jobs for Speed
# ==========================================
# Instead of running all steps sequentially (15+ min),
# we split into 3 parallel jobs:
# 1. Lint + Unit Tests (fast, ~2 min)
# 2. Build + Bundle Size (medium, ~3 min)
# 3. E2E Tests (slow, ~5 min)
# Total time = slowest job (5 min) instead of sum (15+ min)
# ==========================================

jobs:
  # ==========================================
  # JOB 1: LINT + UNIT TESTS + CODE QUALITY
  # ==========================================
  lint_and_unit_test:
    name: Lint, Quality & Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check dependencies
        run: ./scripts/validators/check-dependencies.sh

      # Temporarily disabled - ESLint/AJV compatibility issue
      # - name: Run linting
      #   run: ./scripts/validators/run-lint.sh

      - name: Check code quality & complexity
        run: ./scripts/validators/check-code-quality.sh

      - name: Run unit tests with coverage
        run: ./scripts/validators/run-unit-tests.sh
        env:
          CI: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./packages/*/coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: packages/*/coverage/
          retention-days: 7

  # ==========================================
  # JOB 2: BUILD + BUNDLE SIZE CHECK
  # ==========================================
  build_and_size_check:
    name: Build & Bundle Size
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: ./scripts/validators/build-all.sh

      - name: Check bundle sizes
        run: ./scripts/validators/check-bundle-size.sh

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages-build
          path: packages/*/dist
          retention-days: 1

  # ==========================================
  # JOB 3: E2E TESTS (Slowest, runs in parallel)
  # ==========================================
  e2e_test:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build_and_size_check  # Wait for build artifacts

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: packages-build
          path: packages/

      - name: Install Playwright browsers
        run: pnpm playwright install --with-deps chromium

      - name: Run E2E tests
        run: ./scripts/validators/run-e2e-tests.sh
        env:
          CI: true

      - name: Upload Playwright Report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # ==========================================
  # JOB 4: VALIDATION SUMMARY (Runs after all)
  # ==========================================
  validation_summary:
    name: Post Validation Summary
    runs-on: ubuntu-latest
    needs: [lint_and_unit_test, build_and_size_check, e2e_test]
    if: always()  # Run even if previous jobs failed

    steps:
      - name: Check job results
        id: check_results
        run: |
          echo "lint_status=${{ needs.lint_and_unit_test.result }}" >> $GITHUB_OUTPUT
          echo "build_status=${{ needs.build_and_size_check.result }}" >> $GITHUB_OUTPUT
          echo "e2e_status=${{ needs.e2e_test.result }}" >> $GITHUB_OUTPUT

      - name: Post PR comment with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const lintStatus = '${{ steps.check_results.outputs.lint_status }}';
            const buildStatus = '${{ steps.check_results.outputs.build_status }}';
            const e2eStatus = '${{ steps.check_results.outputs.e2e_status }}';
            
            const statusIcon = (status) => status === 'success' ? 'âœ…' : 'âŒ';
            
            const summary = `## ðŸ¤– Ecosystem Validation Report
            
            | Check | Status |
            |-------|--------|
            | **Lint & Unit Tests** | ${statusIcon(lintStatus)} ${lintStatus} |
            | **Build & Bundle Size** | ${statusIcon(buildStatus)} ${buildStatus} |
            | **E2E Tests** | ${statusIcon(e2eStatus)} ${e2eStatus} |
            
            ${lintStatus === 'success' && buildStatus === 'success' && e2eStatus === 'success' 
              ? 'ðŸŽ‰ **All checks passed!** Ready to merge.' 
              : 'âš ï¸ **Some checks failed.** Please review the details above.'}
            
            ---
            *Powered by [Navigator Validation System](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/VALIDATION.md)*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      # ==========================================
      # PHASE 3: Job Summary for Direct Pushes
      # ==========================================
      # When pushing directly to main/develop (not a PR),
      # post a visible summary in the GitHub Actions UI
      - name: Post Job Summary for Main/Develop Push
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        run: |
          echo "## ðŸš€ Ecosystem Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY

          # Lint & Unit Tests
          if [ "${{ needs.lint_and_unit_test.result }}" = "success" ]; then
            echo "| **Lint & Unit Tests** | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Lint & Unit Tests** | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # Build & Bundle Size
          if [ "${{ needs.build_and_size_check.result }}" = "success" ]; then
            echo "| **Build & Bundle Size** | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Build & Bundle Size** | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          # E2E Tests
          if [ "${{ needs.e2e_test.result }}" = "success" ]; then
            echo "| **E2E Tests** | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **E2E Tests** | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [ "${{ needs.lint_and_unit_test.result }}" = "success" ] && \
             [ "${{ needs.build_and_size_check.result }}" = "success" ] && \
             [ "${{ needs.e2e_test.result }}" = "success" ]; then
            echo "### ðŸŽ‰ All Checks Passed!" >> $GITHUB_STEP_SUMMARY
            echo "The ecosystem is validated and ready for deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Some Checks Failed" >> $GITHUB_STEP_SUMMARY
            echo "Please review the failed checks above." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Powered by [Navigator Validation System](https://github.com/${{ github.repository }}/blob/main/docs/VALIDATION.md)*" >> $GITHUB_STEP_SUMMARY
